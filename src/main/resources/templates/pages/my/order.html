<link rel="stylesheet" th:href="@{/css/my/my.css}">
<link rel="stylesheet" th:href="@{/css/basic.css}">
<link rel="stylesheet" th:href="@{/css/my/popup.css}">
<header th:replace="layout/main/header.html"></header>
<th:block th:replace="layout/my/modal.html"></th:block>
<main style="margin-top: 230px">
  <div id="my">
    <th:block th:replace="layout/my/aside.html"></th:block>
    <main>
      <th:block th:replace="layout/my/banner.html"></th:block>
    <section>
      <h3>전체주문내역</h3>
      <article class="byDate">
        <span class="tit">기간별조회</span>
        <ul class="date_3ea">
          <li><a th:classappend="${type == 'date' && keyword == '7'} ? 'on' : ''" th:href="@{/my/orders(page=0,type='date',keyword=7)}">1주일</a></li>
          <li><a th:classappend="${type == 'date' && keyword == '15'} ? 'on' : ''" th:href="@{/my/orders(page=0,type='date',keyword=15)}">15일</a></li>
          <li><a th:classappend="${type == 'date' && keyword == '30'} ? 'on' : ''" th:href="@{/my/orders(page=0,type='date',keyword=30)}">1개월</a></li>
        </ul>
        <ul class="date_5ea">
          <li><a th:classappend="${type == 'month' && keyword == '5'} ? 'on' : ''" th:href="@{/my/orders(page=0,type='month',keyword=5)}" class="5month_before">5월</a></li>
          <li><a th:classappend="${type == 'month' && keyword == '6'} ? 'on' : ''" th:href="@{/my/orders(page=0,type='month',keyword=6)}">6월</a></li>
          <li><a th:classappend="${type == 'month' && keyword == '7'} ? 'on' : ''" th:href="@{/my/orders(page=0,type='month',keyword=7)}">7월</a></li>
          <li><a th:classappend="${type == 'month' && keyword == '8'} ? 'on' : ''" th:href="@{/my/orders(page=0,type='month',keyword=8)}">8월</a></li>
          <li><a th:classappend="${type == 'month' && keyword == '9'} ? 'on' : ''" th:href="@{/my/orders(page=0,type='month',keyword=9)}">9월</a></li>
        </ul>
        <p>
          <input type="date" max="9999-12-31" /><span>~</span
        ><input type="date" max="9999-12-31" />
        </p>
        <button class="btnConfirm">조회하기</button>
      </article>
      <article>
        <table border="0" class="order">
          <tr>
            <th>날짜</th>
            <th>이미지</th>
            <th>상품정보</th>
            <th>상태</th>
            <th>확인/신청</th>
          </tr>
          <tr th:if="${!orders.isEmpty()}" th:each="order : ${orders}">
            <td class="date" th:text="${order.orderRdate}">2022-12-13</td>
            <td>
              <div class="thumb">
                <a href="#">
                  <img style="width: 80px; height: 80px;" th:src="@{'/file/'+${order.getProdListImg()}}" alt="상품 이미지" />
                </a>
              </div>
            </td>
            <td>
              <ul>
                <li class="company" th:text="${order.seller}">(주) 회사명</li>
                <li class="prodName"><a th:data-order="${order.orderId}" onclick="orderPop(this)" th:text="${order.orderItemCount}>1 ? ${order.prodName}+'외'+(${order.orderItemCount}-1)+'개' : ${order.prodName}">상품명</a></li>
                <li>
                  수량 : <span class="prodCount" th:text="${order.orderQuantity}==null?0:${order.orderQuantity}">5</span>개 / 주문번호 :
                  <span class="ordNo" th:text="${order.orderId}">1234567</span>
                </li>
                <li class="prodPrice" th:text="${order.orderTotal}==null?0:${order.orderTotal}">34,000</li>
              </ul>
            </td>
            <td class="status" th:switch="${order.orderState}">
              <span th:case="0">결제완료</span>
              <span th:case="1">배송중</span>
              <span th:case="2">수취확인버튼발사대</span>
              <span th:case="3">상품평버튼발사대</span>
              <span th:case="4">주문완료</span>
            </td>
            <td class="confirm">
              <button th:if="${order.orderState==0}" class="exchange grey">주문취소</button>
              <button th:if="${order.orderState==1}" th:data-id="${order.orderId}" onclick="opendeliDate(event)" class="exchange grey">배송예정일</button>
              <button th:if="${order.orderState==2 || order.orderState==3}" th:data-id="${order.orderId}" onclick="openReceive(event)" class="receive color">수취확인</button>
              <button th:if="${order.orderState==3 || order.orderState==4}" onclick="openReviewWrite(event)" th:data-name="${order.prodName}" th:data-id="${order.orderId}" th:data-prod="${order.prodId}" class="review color">상품평쓰기</button>
              <button th:if="${order.orderState==2 || order.orderState==3}" th:data-id="${order.orderId}" onclick="openReturn(event)" class="refund grey">반품신청</button>
              <button th:if="${order.orderState==2 || order.orderState==3}" th:data-id="${order.orderId}" onclick="openChange(event)" class="exchange grey">교환신청</button>
            </td>
          </tr>
        </table>
        <div th:unless="${!orders.isEmpty()}"
                style="
              width: 100%;
              height: 150px;
              font-size: 14px;
              line-height: 150px;
              text-align: center;
            "
        >
          주문 내역이 없습니다.
        </div>
        <div th:if="${noItem==false}" class="page">
          <a class="none" th:href="@{/my/orders(page=0,type=${type},keyword=${keyword})}"><<</a>
          <a class="none" th:href="@{/my/orders(page=${page - 2},type=${type},keyword=${keyword})}" th:if="${page>=2}" th:text="${page}-1"></a>
          <a class="none" th:href="@{/my/orders(page=${page - 1},type=${type},keyword=${keyword})}" th:if="${page>=1}" th:text="${page}"></a>
          <a class="active" style="font-weight: 600; text-decoration: underline;" th:text="${page}+1"></a>
          <a class="none" th:href="@{/my/orders(page=${page + 1},type=${type},keyword=${keyword})}" th:if="${(totalPages - page)>=2}" th:text="${page}+2"></a>
          <a class="none" th:href="@{/my/orders(page=${page + 2},type=${type},keyword=${keyword})}" th:if="${(totalPages - page)>=3}" th:text="${page}+3"></a>
          <a class="none" th:href="@{/my/orders(page=${totalPages - 1},type=${type},keyword=${keyword})}">>></a>
        </div>
      </article>

    </section>
    </main>
  </div>
</main>
<footer th:replace="layout/main/footer.html"></footer>


<script>

  async function openReturn(event){
    const orderId = event.target.dataset.id;
    const popReturn = document.getElementById('popReturn')
    try {
      const resp = await axios.get(`/my/order/receive?id=${orderId}`,null,{
        headers:{
          "Content-Type" : "application/json"
        }
      })
      const selectItem = popReturn.querySelector('select')
      if(resp.data.length>0){
        selectItem.innerHTML = resp.data.map(v=>`
        <option value="${v.orderItemId}">${v.prodName}</option>
      `)
      } else {
        selectItem.innerHTML = `
          <option>배송완료된 상품이 없습니다.</option>
        `
      }
      popReturn.showModal();
    } catch (e) {

    }
  }

  async function openChange(event){
    const orderId = event.target.dataset.id;
    const popChange = document.getElementById('popChange')
    try {
      const resp = await axios.get(`/my/order/receive?id=${orderId}`,null,{
        headers:{
          "Content-Type" : "application/json"
        }
      })
      const selectItem = popChange.querySelector('select')
      if(resp.data.length>0){
        selectItem.innerHTML = resp.data.map(v=>`
        <option value="${v.orderItemId}">${v.prodName}</option>
      `)
      } else {
        selectItem.innerHTML = `
          <option>배송완료된 상품이 없습니다.</option>
        `
      }
      popChange.showModal();
    } catch (e) {

    }
  }

  async function openReceive(event){
    const orderId = event.target.dataset.id
    try {
      const popReceive = document.getElementById('popReceive')
      const resp = await axios.get(`/my/order/receive?id=${orderId}`,null,{
        headers:{
          "Content-Type" : "application/json"
        }
      })
      const selectItem = popReceive.querySelector('select')
      if(resp.data.length>0){
        selectItem.innerHTML = resp.data.map(v=>`
        <option value="${v.orderItemId}">${v.prodName}</option>
      `)
      } else {
        selectItem.innerHTML = `
          <option>배송완료된 상품이 없습니다.</option>
        `
      }

      popReceive.showModal();
    } catch (e) {
      
    }
  }

  async function receiveConfirmBtn(){
    const popReceive = document.getElementById('popReceive')
    const selectItem = popReceive.querySelector('select')
    const selectedItemId = selectItem.options[selectItem.selectedIndex]
    const orderItemId = selectedItemId.value;
    
    try {
      const resp = await axios.patch(`/my/order/receive?id=${orderItemId}`,null,{
        headers:{
          "Content-Type" : "application/json"
        }
      })
      if(resp.status ===200){
        document.getElementById('popReceive').close();
        window.location.href = '/my/orders'
      }
    } catch (e) {
      
    }
  }

  async function postReturn(){
    const popReceive = document.getElementById('popReturn')
    const selectItem = popReceive.querySelector('select')
    const selectedItemId = selectItem.options[selectItem.selectedIndex]
    const orderItemId = selectedItemId.value;
    try {
      const resp = await axios.patch(`/my/order/return?id=${orderItemId}`,null,{
        headers:{
          "Content-Type" : "application/json"
        }
      })
      if(resp.status ===200){
        document.getElementById('popReturn').close();
        window.location.href = '/my/orders'
      }
    } catch (e) {

    }
  }

  async function postChange(){
    const popReceive = document.getElementById('popChange')
    const selectItem = popReceive.querySelector('select')
    const selectedItemId = selectItem.options[selectItem.selectedIndex]
    const orderItemId = selectedItemId.value;
    try {
      const resp = await axios.patch(`/my/order/change?id=${orderItemId}`,null,{
        headers:{
          "Content-Type" : "application/json"
        }
      })
      if(resp.status ===200){
        document.getElementById('popChange').close();
        window.location.href = '/my/orders'
      }
    } catch (e) {

    }
  }

  function closeReceive(){
    document.getElementById('popReceive').close();
  }
  function closeReturn(){
    document.getElementById('popReturn').close();
  }
  function closeChange(){
    document.getElementById('popChange').close();
  }

  async function opendeliDate(event){
    console.log(event.target.dataset.id)
    try {
      const resp = await axios.get(`/my/order/delivery-date?id=${event.target.dataset.id}`,null,{
        headers:{
          "Content-Type" : "application/json"
        }
      })
      const deliModal = document.getElementById('popDeliveryDate')
      deliModal.querySelector('section').innerHTML =
        resp.data.map(v=>`
        <div style="display: flex;justify-content: space-between; border-bottom: 1px solid black;">
          <span style="font-weight: 600;">${v.prodName.length > 30 ? v.prodName.substring(0, 30) + '...' : v.prodName}</span>
          <span>${v.date}</span>
        </div>
      `)
      deliModal.showModal();
    } catch (e) {
      console.log(e)
    }


  }

  function closeDelivery(){
    document.getElementById('popDeliveryDate').close();
  }

  const popOrderDialog = document.getElementById("popOrder");
  async function orderPop(element) {
    event.preventDefault();
    const orderId = event.target.dataset.order
    console.log('orderId : '+orderId)



    try {
      const resp = await axios.get("/my/order/orderInfo", {
        headers: {
          "Content-Type": "application/json"
        },
        params: {
          "orderId": orderId
        }
      })
      const orders = resp.data;
      console.log("resp data : "+orders.orderId)
      console.log("resp data orderItemDtos: "+orders.custName)
      orders.orderItemDtos.forEach((item, index) => {
        console.log(`Order Item ${index + 1}`);
        console.log("Product Image: " + item.prodListImg);
        console.log("Product Name: " + item.prodName);
        console.log("Product Price: " + item.prodPrice);
        console.log("Discount: " + item.discount);
        console.log("Quantity: " + item.quantity);
        console.log("Total Price: " + item.totalPrice);
        console.log("Delivery: " + item.delivery);
        console.log("Seller Name: " + item.sellerName);
        console.log("Order Delivery ID: " + item.orderDeliId);
        console.log("Order Item State: " + item.orderItemState2);
        console.log("Options: " + item.options.join(", "));
      });

      popOrderDialog.showModal();
    } catch (e) {
      console.log(e)
    }
  }

  function closeModal(){
    popOrderDialog.close();
  }


</script>