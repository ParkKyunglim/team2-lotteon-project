<link rel="stylesheet" th:href="@{/css/admin/config/banner.css}">
<link rel="stylesheet" th:href="@{/css/basic.css}">
<body>
    <header th:replace="layout/admin/header.html"></header>
    <main>
        <aside th:replace="layout/admin/aside.html"></aside>
        <div class="container">
            <div class="header">
                <span class="header-title">배너관리</span>
                <div class="header-right">
                    <span>HOME</span>
                    <span>></span>
                    <span>환경설정</span>
                    <span>></span>
                    <span class="bold">배너관리</span>
                </div>
            </div>

            <div class="header-gubun"></div>

            <div class="main">
                <div class="section">
                    <div onclick="nav(event)" class="tab1 banner-main-top active">메인상단 배너</div>
                    <div onclick="nav(event)" class="tab2 banner-main-slide">메인슬라이드 배너</div>
                    <div onclick="nav(event)" class="tab3 banner-product-view">상품 상세보기 배너</div>
                    <div onclick="nav(event)" class="tab4 banner-login">회원로그인 배너</div>
                    <div onclick="nav(event)" class="tab5 banner-my">마이페이지 배너</div>
                </div>

                <div class="header-title2">메인상단 배너</div>
                <div class="header-gubun2"></div>

                <table class="tb1">
                    <tr>
                        <th class="checkbox">
                            <input type="checkbox" id="allCheck">
                        </th>
                        <th class="no">번호</th>
                        <th class="img">이미지</th>
                        <th class="info">배너정보</th>
                        <th class="place">배너위치</th>
                        <th class="start-date">시작일</th>
                        <th class="end-date">종료일</th>
                        <th class="start-time">시작시간</th>
                        <th class="end-time">종료시간</th>
                        <th class="admin">관리</th>
                    </tr>
                    <tr>
                        <td class="checkbox">
                            <input type="checkbox" name="" id="">
                        </td>
                        <td>1</td>
                        <td>
                            <img src="../images/x-img2.png" alt="">
                        </td>
                        <td class="td-info">
                            <div class="name">특정배너명</div>
                            <div class="size">크기 : 1200 x 80</div>
                            <div class="bgcolor">배경색 : #ffff00</div>
                            <div class="link">배너링크</div>
                        </td>
                        <td>MAIN1</td>
                        <td>2023/01/01</td>
                        <td>2023/01/07</td>
                        <td>13:00</td>
                        <td>15:00</td>
                        <td class="td-admin">
                            <input type="button" value="[ 삭제 ]">
                            <input type="button" value="[ 수정 ]">
                        </td>
                    </tr>
                    <tr>
                        <td class="checkbox">
                            <input type="checkbox" name="" id="">
                        </td>
                        <td>1</td>
                        <td>
                            <img th:src="@{/images/x-img2.png}" alt="">
                        </td>
                        <td class="td-info">
                            <div class="name">특정배너명</div>
                            <div class="size">크기 : 1200 x 80</div>
                            <div class="bgcolor">배경색 : #ffff00</div>
                            <div class="link">배너링크</div>
                        </td>
                        <td>MAIN1</td>
                        <td>2023/01/01</td>
                        <td>2023/01/07</td>
                        <td>13:00</td>
                        <td>15:00</td>
                        <td class="td-admin">
                            <input type="button" value="[ 삭제 ]">
                            <input type="button" value="[ 수정 ]">
                        </td>
                    </tr>
                    <tr>
                        <td class="checkbox">
                            <input type="checkbox" name="" id="">
                        </td>
                        <td>1</td>
                        <td>
                            <img th:src="@{/images/x-img2.png}" alt="">
                        </td>
                        <td class="td-info">
                            <div class="name">특정배너명</div>
                            <div class="size">크기 : 1200 x 80</div>
                            <div class="bgcolor">배경색 : #ffff00</div>
                            <div class="link">배너링크</div>
                        </td>
                        <td>MAIN1</td>
                        <td>2023/01/01</td>
                        <td>2023/01/07</td>
                        <td>13:00</td>
                        <td>15:00</td>
                        <td class="td-admin">
                            <input type="button" value="[ 삭제 ]">
                            <input type="button" value="[ 수정 ]">
                        </td>
                    </tr>
                    <tr>
                        <td class="checkbox">
                            <input type="checkbox" name="" id="">
                        </td>
                        <td>1</td>
                        <td>
                            <img th:src="@{/images/x-img2.png}" alt="">
                        </td>
                        <td class="td-info">
                            <div class="name">특정배너명</div>
                            <div class="size">크기 : 1200 x 80</div>
                            <div class="bgcolor">배경색 : #ffff00</div>
                            <div class="link">배너링크</div>
                        </td>
                        <td>MAIN1</td>
                        <td>2023/01/01</td>
                        <td>2023/01/07</td>
                        <td>13:00</td>
                        <td>15:00</td>
                        <td class="td-admin">
                            <input type="button" value="[ 삭제 ]">
                            <input type="button" value="[ 수정 ]">
                        </td>
                    </tr>
                    <tr>
                        <td class="checkbox">
                            <input type="checkbox" name="" id="">
                        </td>
                        <td>1</td>
                        <td>
                            <img th:src="@{/images/x-img2.png}" alt="">
                        </td>
                        <td class="td-info">
                            <div class="name">특정배너명</div>
                            <div class="size">크기 : 1200 x 80</div>
                            <div class="bgcolor">배경색 : #ffff00</div>
                            <div class="link">배너링크</div>
                        </td>
                        <td>MAIN1</td>
                        <td>2023/01/01</td>
                        <td>2023/01/07</td>
                        <td>13:00</td>
                        <td>15:00</td>
                        <td class="td-admin">
                            <input type="button" value="[ 삭제 ]">
                            <input type="button" value="[ 수정 ]">
                        </td>
                    </tr>
                    <tr>
                        <td class="checkbox">
                            <input type="checkbox" name="" id="">
                        </td>
                        <td>1</td>
                        <td>
                            <img th:src="@{/images/x-img2.png}" alt="">
                        </td>
                        <td class="td-info">
                            <div class="name">특정배너명</div>
                            <div class="size">크기 : 1200 x 80</div>
                            <div class="bgcolor">배경색 : #ffff00</div>
                            <div class="link">배너링크</div>
                        </td>
                        <td>MAIN1</td>
                        <td>2023/01/01</td>
                        <td>2023/01/07</td>
                        <td>13:00</td>
                        <td>15:00</td>
                        <td class="td-admin">
                            <input type="button" value="[ 삭제 ]">
                            <input type="button" value="[ 수정 ]">
                        </td>
                    </tr>
                </table>
                <div class="btns">
                    <button class="delete-btn">선택삭제</button>
                    <button onclick="openBanner()" class="insert-btn">배너등록</button>
                </div>

            </div>
            <div class="popup">
                <div class="header">
                    <div class="title">배너등록</div>
                    <div onclick="closeBanner()" class="btn">X</div>
                </div>
                <form id="bannerForm">
                    <table class="tb2">
                        <tr>
                            <th>배너이름</th>
                            <td>
                                <input class="inp" type="text" name="bannerName" placeholder="배너명 입력">
                            </td>
                        </tr>
                        <tr>
                            <th>배너 이미지</th>
                            <td>
                                <input class="inp" type="file" name="bannerUpload">
                            </td>
                        </tr>
                        <tr>
                            <th>배너크기</th>
                            <td>
                                <input class="inp" type="text" name="bannerSize" placeholder="배너크기 입력">
                            </td>
                        </tr>
                        <tr>
                            <th>배경색</th>
                            <td>
                                <input class="short" type="color" name="bannerBg" placeholder="배경색 입력">
                            </td>
                        </tr>
                        <tr>
                            <th>배너 링크</th>
                            <td>
                                <input class="inp" type="text" name="bannerLink" placeholder="배너와 연결될 링크 입력">
                            </td>
                        </tr>
                        <tr>
                            <th>배너위치</th>
                            <td>
                                <select class="place short" name="bannerLocation">
                                    <option value="1">MAIN1</option>
                                    <option value="2">MAIN2</option>
                                    <option value="3">PRODUCT1</option>
                                    <option value="4">MEMBER1</option>
                                    <option value="5">MY1</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <th>노출날짜</th>
                            <td>
                                <input id="start-date" type="date" name="bannerSdate"> ~
                                <input id="end-date" type="date" name="bannerEdate">
                            </td>
                        </tr>
                        <tr>
                            <th>노출시간</th>
                            <td>
                                <input id="start-time" type="time" data-placeholder="시 : 분" name="bannerStime"> ~
                                <input id="end-time" type="time" data-placeholder="시 : 분" name="bannerEtime">
                            </td>
                        </tr>
                    </table>
                    <div class="btns">
                        <button type="submit" class="submit-btn">등록하기</button>
                    </div>
                </form>
            </div>
            <div class="popupbg"></div>
        </div>
    </main>

    <footer th:replace="layout/admin/footer.html"></footer>
    


    <script>
        const popup = document.querySelector('.popup')
        const bg = document.querySelector('.popupbg')

        function openBanner(){
            popup.style.display = 'block'
            bg.style.display = 'block'
        }
        function closeBanner(){
            popup.style.display = 'none'
            bg.style.display = 'none'
        }
        document.getElementById('start-time').addEventListener('focus', function() {
            this.showPicker();
        });
        document.getElementById('end-time').addEventListener('focus', function() {
            this.showPicker();
        });
        document.getElementById('start-date').addEventListener('focus', function() {
            this.showPicker();
        });
        document.getElementById('end-date').addEventListener('focus', function() {
            this.showPicker();
        });

        function nav(event) {
            // 모든 요소에서 active 클래스를 제거
            const allBanners = document.querySelectorAll('.section > div');
            allBanners.forEach(function(banner) {
                banner.classList.remove('active');
            });
            
            // 클릭한 요소에만 active 클래스 추가
            event.target.classList.add('active');
            document.querySelector('.header-title2').innerText = document.querySelector('.active').innerText    
        }

        const imgInput = document.getElementsByName('bannerUpload')[0];
        const imgSize = document.getElementsByName('bannerSize')[0];
        var imgRatio = 0;
        const option = document.getElementsByTagName('option');

        // 파일 업로드 input의 change 이벤트를 감지.
        imgInput.addEventListener('change', function() {
            var file = imgInput.files[0];

            // 파일의 크기를 체크합니다.
            if (file.size > 500 * 1024) {
                // 파일 크기가 500KB를 넘는 경우 처리합니다.
                alert('이미지 파일의 크기는 최대 500KB 이하이어야 합니다.');
                imgInput.value = '';
                imgSize.value = '';
                return;
            }

            var reader = new FileReader();

            reader.onload = function(e) {
                var image = new Image();
                image.onload = function() {
                    var width = this.width;
                    var height = this.height;

                    imgRatio = width/height;
                    imgSize.value = width + "px × " + height + "px";
                    option[0].disabled = false;
                    option[1].disabled = false;
                    option[2].disabled = false;
                    option[3].disabled = false;
                    option[4].disabled = false;
                    if(imgRatio<2){
                        option[3].selected = true;
                    }else if(imgRatio<3.3){
                        option[1].selected = true;
                    }else if(imgRatio>10){
                        option[0].selected = true;
                    }else{
                        option[2].selected = true;
                        option[0].disabled = true;
                        option[1].disabled = true;
                        option[3].disabled = true;
                    }
                };
                // 이미지 객체에 파일 데이터를 설정하고 로드.
                image.src = e.target.result;
            };
            reader.readAsDataURL(imgInput.files[0]);
        });

        const f = document.getElementById('bannerForm');

        f.addEventListener("submit", function (e) {
            e.preventDefault();
            // 클릭 후 비활성화로 중복 클릭 방지
            const button = f.querySelector('button[type="submit"]');
            button.disabled = true;

            const formData = new FormData(this);

            fetch('/admin/config/banner', {
                method: 'POST',
                body: formData
            })
                .then(resp => resp.json())
                .then(data => {
                    console.log(data);
                    const tab = data.bannerLocation;
                     if(tab>0){
                         alert('성공적으로 등록되었습니다.');
                         closeBanner();

                         const allBanners = document.querySelectorAll('.section > div');
                         allBanners.forEach(function(banner) {
                             banner.classList.remove('active');
                         });
                         const Banner = document.getElementsByClassName('tab'+tab)[0];

                         Banner.classList.add('active');
                         document.querySelector('.header-title2').innerText = document.querySelector('.active').innerText

                         window.scrollTo({ // 페이지 상단으로 스크롤 이동
                             top: 0,
                             behavior: 'smooth' // 부드럽게 스크롤 이동
                         });

                         f.reset();
                     }
                })
                .catch(err =>{
                    console.error(err);
                })
                .finally(() => {
                    // fetch 완료 후 버튼 다시 활성화
                    button.disabled = false;
                });

        });

    </script>
</body>
</html>